AmCharts.AmExport=AmCharts.Class({construct:function(e,t,n){var r=this;r.DEBUG=!1,r.chart=e,r.canvas=null,r.svgs=[],r.userCFG=t,r.buttonIcon="export.png",r.exportPNG=!0,r.exportPDF=!1,r.exportJPG=!1,r.exportSVG=!1,r.right=0,r.top=0,r.buttonRollOverColor="#EFEFEF",r.textRollOverColor="#CC0000",r.buttonTitle="Save chart as an image",r.buttonAlpha=.75,r.imageFileName="amChart",r.imageBackgroundColor="#FFFFFF",n&&r.init()},toCoordinate:function(e){return e===undefined?"auto":String(e).indexOf("%")!=-1?e:e+"px"},init:function(){var e=this,t=[];e.exportPNG&&t.push("png"),e.exportPDF&&t.push("pdf"),e.exportJPG&&t.push("jpg"),e.exportSVG&&t.push("svg");var n=[];if(t.length==1){var r=t[0];n.push({format:r,iconTitle:e.buttonTitle,icon:e.chart.pathToImages+e.buttonIcon})}else if(t.length>1){var i=[];for(var s=0;s<t.length;s++)i.push({format:t[s],title:t[s].toUpperCase()});n.push({onclick:function(){},icon:e.chart.pathToImages+e.buttonIcon,items:i})}var o=e.color;o===undefined&&(o=e.chart.color);var u=e.buttonColor;u===undefined&&(u="transparent"),e.cfg={menuTop:e.toCoordinate(e.top),menuLeft:e.toCoordinate(e.left),menuRight:e.toCoordinate(e.right),menuBottom:e.toCoordinate(e.bottom),menuItems:n,menuItemStyle:{backgroundColor:u,opacity:e.buttonAlpha,rollOverBackgroundColor:e.buttonRollOverColor,color:o,rollOverColor:e.textRollOverColor,paddingTop:"6px",paddingRight:"6px",paddingBottom:"6px",paddingLeft:"6px",marginTop:"0px",marginRight:"0px",marginBottom:"0px",marginLeft:"0px",textAlign:"left",textDecoration:"none",fontFamily:e.chart.fontFamily,fontSize:e.chart.fontSize+"px"},menuItemOutput:{backgroundColor:e.imageBackgroundColor,fileName:e.imageFileName,format:"png",output:"dataurlnewwindow",render:"browser",dpi:90,onclick:function(e,t,n){n.preventDefault(),e.output(t)}},removeImagery:!0},e.processing={buffer:[],drawn:0,timer:0},typeof window.canvg!="undefined"&&typeof window.RGBColor!="undefined"&&(e.cfg.menuItemOutput.render="canvg"),typeof window.saveAs!="undefined"&&(e.cfg.menuItemOutput.output="save"),AmCharts.isIE&&AmCharts.IEversion<10&&(e.cfg.menuItemOutput.output="dataurlnewwindow");var a=e.userCFG;a&&(a.menuItemOutput=AmCharts.extend(e.cfg.menuItemOutput,a.menuItemOutput||{}),a.menuItemStyle=AmCharts.extend(e.cfg.menuItemStyle,a.menuItemStyle||{}),e.cfg=AmCharts.extend(e.cfg,a)),e.chart.AmExport=e,e.chart.addListener("rendered",function(){e.setup()}),e.DEBUG&&(window.AmExport=e)},log:function(){console.log("AmExport: ",arguments)},setup:function(){var e=this;e.DEBUG==10&&e.log("SETUP START"),!AmCharts.isIE||AmCharts.isIE&&AmCharts.IEversion>9?(e.generateButtons(),e.DEBUG==10&&e.log("SETUP END")):e.DEBUG==10&&e.log("< IE10 NOT SUPPORTED")},generateBinaryArray:function(e){var t=e.length,n=new Uint8Array(t/4*3|0),r=0,i=0,s=[0,0],o=0,u=0,a,f,l,c=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);while(t--)f=e.charCodeAt(r++),a=c[f-43],a!==255&&a!==l&&(s[1]=s[0],s[0]=f,u=u<<6|a,o++,o===4&&(n[i++]=u>>>16,s[1]!==61&&(n[i++]=u>>>8),s[0]!==61&&(n[i++]=u),o=0));return n},generateBlob:function(e,t){var n=this,r=t!="image/svg+xml"?e.indexOf(",")+1:0,i=e.substring(0,r),s=e,o=new Blob;return i.indexOf("base64")!=-1&&(s=n.generateBinaryArray(e.substring(r))),AmCharts.isIE&&AmCharts.IEversion<10?(o.data=s,o.size=s.length,o.type=t,o.encoding="base64"):o=new Blob([s],{type:t}),o},generatePDF:function(e){var t=this,n={output:function(){return""}},r=t.canvas.toDataURL("image/jpeg"),i=t.canvas.width*25.4/e.dpi,s=t.canvas.height*25.4/e.dpi;return window.jsPDF?(n=new jsPDF,n.addImage?n.addImage(r,"JPEG",0,0,i,s):alert("Missing jsPDF plugin; Please add the 'addImage' plugin.")):alert("Missing jsPDF lib; Don't forget to add the addImage plugin."),n},output:function(e,t){function r(){var r=null,i;n.DEBUG==10&&n.log("OUTPUT",e.format);if(e.format=="image/svg+xml"||e.format=="svg")r=n.generateSVG(),i=n.generateBlob(r,"image/svg+xml"),e.output=="save"?saveAs(i,e.fileName+".svg"):e.output=="datastring"||e.output=="datauristring"||e.output=="dataurlstring"?i="data:image/svg+xml;base64,"+btoa(r):e.output=="dataurlnewwindow"?window.open("data:image/svg+xml;base64,"+btoa(r)):e.output=="datauri"||e.output=="dataurl"?location.href="data:image/svg+xml;base64,"+btoa(r):e.output=="datastream"&&(location.href="data:image/octet-stream;base64,"+r),t&&t.apply(n,[i]);else if(e.format=="application/pdf"||e.format=="pdf")r=n.generatePDF(e).output("dataurlstring"),i=n.generateBlob(r,"application/pdf"),e.output=="save"?saveAs(i,e.fileName+".pdf"):e.output=="datastring"||e.output=="datauristring"||e.output=="dataurlstring"?i=r:e.output=="dataurlnewwindow"?window.open(r):e.output=="datauri"||e.output=="dataurl"?location.href=r:e.output=="datastream"&&(location.href=r.replace("application/pdf","application/octet-stream")),t&&t.apply(n,[i]);else if(e.format=="image/png"||e.format=="png")r=n.canvas.toDataURL("image/png"),i=n.generateBlob(r,"image/png"),e.output=="save"?saveAs(i,e.fileName+".png"):e.output=="datastring"||e.output=="datauristring"||e.output=="dataurlstring"?i=r:e.output=="dataurlnewwindow"?window.open(r):e.output=="datauri"||e.output=="dataurl"?location.href=r:e.output=="datastream"&&(location.href=r.replace("image/png","image/octet-stream")),t&&t.apply(n,[i]);else if(e.format=="image/jpeg"||e.format=="jpeg"||e.format=="jpg")r=n.canvas.toDataURL("image/jpeg"),i=n.generateBlob(r,"image/jpeg"),e.output=="save"?saveAs(i,e.fileName+".jpg"):e.output=="datastring"||e.output=="datauristring"||e.output=="dataurlstring"?i=r:e.output=="dataurlnewwindow"?window.open(r):e.output=="datauri"||e.output=="dataurl"?location.href=r:e.output=="datastream"&&(location.href=r.replace("image/jpeg","image/octet-stream")),t&&t.apply(n,[i])}var n=this;return e=AmCharts.extend(AmCharts.extend({},n.cfg.menuItemOutput),e||{}),n.chart.prepareForExport&&n.chart.prepareForExport(),n.generateOutput(e,r)},polifySVG:function(e){function n(e,n){var r=e.getElementsByTagName(n),i=r.length;while(i--){if(t.cfg.removeImagery)r[i].parentNode.removeChild(r[i]);else{var s=document.createElement("img"),o=document.createElement("canvas"),u=o.getContext("2d");o.width=r[i].getAttribute("width"),o.height=r[i].getAttribute("height"),s.src=r[i].getAttribute("xlink:href"),s.width=r[i].getAttribute("width"),s.height=r[i].getAttribute("height");try{u.drawImage(s,0,0,s.width,s.height),datastring=o.toDataURL()}catch(a){throw datastring=s.src,t.log("Tainted canvas, reached browser CORS security; origin from imagery must be equal to the server!"),new Error(a)}r[i].setAttribute("xlink:href",datastring)}t.DEBUG==10&&t.log("POLIFIED",r[i])}}var t=this;return AmCharts.IEversion==0&&(e.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.cfg.removeImagery||e.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink")),t.DEBUG==10&&t.log("POLIFIED",e),n(e,"pattern"),n(e,"image"),t.svgs.push(e),e},generateSVG:function(){var e=this,t=document.createElement("svg");t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");for(var n=0;n<e.processing.buffer.length;n++){var r=document.createElement("g"),i=e.processing.buffer[n];i[0].setAttribute("xmlns","http://www.w3.org/2000/svg"),i[0].setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),r.setAttribute("transform","translate("+i[1].x+","+i[1].y+")"),r.appendChild(i[0]),t.appendChild(r)}return(new XMLSerializer).serializeToString(t)},generateOutput:function(e,t){function d(){var r,o,u,a;if(n.processing.buffer.length==n.processing.drawn||e.format=="svg")return n.DEBUG==10&&n.log("END DRAWING"),t();n.DEBUG==10&&n.log("DRAW",n.processing.drawn+1,"OF",n.processing.buffer.length),o=n.processing.buffer[n.processing.drawn],a=(new XMLSerializer).serializeToString(o[0]),u=o[1],n.DEBUG==10&&n.log("SOURCE",a);if(e.render=="browser"){r=new Image,r.id=AmCharts.getUniqueId(),a="data:image/svg+xml;base64,"+btoa(a),r.onload=function(){s.drawImage(this,o[1].x,o[1].y),n.processing.drawn++,n.DEBUG==10&&n.log("ONLOAD",this),d()},r.onerror=function(){n.DEBUG==10&&n.log("ONERROR",this),s.drawImage(this,o[1].x,o[1].y),n.processing.drawn++,d()},r.src=a,n.DEBUG==10&&n.log("ADD",r);if(r.complete||typeof r.complete=="undefined"||r.complete===undefined)n.DEBUG==10&&n.log("FORCE ONLOAD",r),r.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",r.src=a}else e.render=="canvg"&&canvg(i,a,{offsetX:u.x,offsetY:u.y,ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,renderCallback:function(){n.processing.drawn++,d()}})}var n=this,r=n.chart.div.getElementsByTagName("svg"),i=document.createElement("canvas"),s=i.getContext("2d"),o={y:0,x:0},u={};n.processing.buffer=[],n.processing.drawn=0,n.canvas=i,n.svgs=[],n.DEBUG==10&&n.log("START EXPORT"),n.DEBUG==10&&n.log("START BUFFERING");for(var a=0;a<r.length;a++){var f=r[a].parentNode,l=Number(f.style.left.slice(0,-2)),c=Number(f.style.top.slice(0,-2)),h=n.polifySVG(r[a].cloneNode(!0)),u=AmCharts.extend({},o);f.style.position=="relative"?(o.x=l?l:o.x,o.y=c?c:o.y):(o.x=l,o.y=c),n.processing.buffer.push([h,AmCharts.extend({},o)]),c&&l?o=u:o.y+=c?0:f.offsetHeight,n.DEBUG==10&&n.log("BUFFERED",r[a],o)}n.DEBUG==10&&n.log("END BUFFERING"),n.DEBUG==10&&n.log("START DRAWING",e.render),n.DEBUG==10&&n.log("FILL BACKGROUND"),i.id=AmCharts.getUniqueId(),i.width=n.chart.divRealWidth,i.height=n.chart.divRealHeight;var p={width:!1,height:!1};n.chart.periodSelector&&(["left","right"].indexOf(n.chart.periodSelector.position)!=-1?(i.width-=n.chart.periodSelector.div.offsetWidth+16,p.width=!0):(i.height-=n.chart.periodSelector.div.offsetHeight,p.height=!0)),n.chart.dataSetSelector&&(["left","right"].indexOf(n.chart.dataSetSelector.position)!=-1?p.width||(i.width-=n.chart.dataSetSelector.div.offsetWidth+16):i.height-=n.chart.dataSetSelector.div.offsetHeight);if(e.backgroundColor||e.format=="image/jpeg")s.fillStyle=e.backgroundColor||"#FFFFFF",s.fillRect(0,0,i.width,i.height);return d()},generateButtons:function(){function r(t){var i=document.createElement("ul");i.setAttribute("style","list-style: none; margin: 0; padding: 0;");for(var s=0;s<t.length;s++){var o=document.createElement("li"),u=document.createElement("img"),a=document.createElement("a"),f=t[s],l=null,c=AmCharts.extend(AmCharts.extend({},e.cfg.menuItemStyle),t[s]);f=AmCharts.extend(AmCharts.extend({},e.cfg.menuItemOutput),f),f.icon&&(u.alt="",u.src=f.icon,u.setAttribute("style","margin: 0 auto;border: none;outline: none"),f.iconTitle&&(u.title=f.iconTitle),a.appendChild(u)),a.href="#",f.title&&(u.setAttribute("style","margin-right: 5px;"),a.innerHTML+=f.title),a.setAttribute("style","display: block;"),AmCharts.extend(a.style,c),a.onclick=f.onclick.bind(a,e,f),o.appendChild(a),f.items&&(l=r(f.items),o.appendChild(l),o.onmouseover=function(){l.style.display="block"},o.onmouseout=function(){l.style.display="none"},l.style.display="none"),i.appendChild(o),a.onmouseover=function(){this.style.backgroundColor=c.rollOverBackgroundColor,this.style.color=c.rollOverColor,this.style.borderColor=c.rollOverBorderColor},a.onmouseout=function(){this.style.backgroundColor=c.backgroundColor,this.style.color=c.color,this.style.borderColor=c.borderColor}}return n++,e.DEBUG==10&&e.log("MENU",i),i}var e=this,t=document.createElement("div"),n=0;t.setAttribute("style","width:39px; height:28px; position: absolute;top:"+e.cfg.menuTop+";right:"+e.cfg.menuRight+";bottom:"+e.cfg.menuBottom+";left:"+e.cfg.menuLeft+";box-shadow:0px 0px 1px 0px rgba(0,0,0,0);"),t.setAttribute("class","amExportButton"),t.appendChild(r(e.cfg.menuItems)),e.chart.containerDiv.appendChild(t)}});