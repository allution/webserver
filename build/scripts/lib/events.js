define(["lib/lodash"],function(e){var t=[].slice,n={on:function(e,t,n){if(!i(this,"on",e,[t,n])||!t)return this;this._events||(this._events={});var r=this._events[e]||(this._events[e]=[]);return r.push({callback:t,context:n,ctx:n||this}),this},once:function(t,n,r){if(!i(this,"once",t,[n,r])||!n)return this;var s=this,o=e.once(function(){s.off(t,o),n.apply(this,arguments)});return o._callback=n,this.on(t,o,r)},off:function(t,n,r){var s,o,u,a,f,l,c,h;if(!this._events||!i(this,"off",t,[n,r]))return this;if(!t&&!n&&!r)return this._events=void 0,this;a=t?[t]:e.keys(this._events);for(f=0,l=a.length;f<l;f++){t=a[f];if(u=this._events[t]){this._events[t]=s=[];if(n||r)for(c=0,h=u.length;c<h;c++)o=u[c],(n&&n!==o.callback&&n!==o.callback._callback||r&&r!==o.context)&&s.push(o);s.length||delete this._events[t]}}return this},trigger:function(e){if(!this._events)return this;var n=t.call(arguments,1);if(!i(this,"trigger",e,n))return this;var r=this._events[e],o=this._events.all;return r&&s(r,n),o&&s(o,arguments),this},stopListening:function(t,n,r){var i=this._listeningTo;if(!i)return this;var s=!n&&!r;!r&&typeof n=="object"&&(r=this),t&&((i={})[t._listenId]=t);for(var o in i)t=i[o],t.off(n,r,this),(s||e.isEmpty(t._events))&&delete this._listeningTo[o];return this}},r=/\s+/,i=function(e,t,n,i){if(!n)return!0;if(typeof n=="object"){for(var s in n)e[t].apply(e,[s,n[s]].concat(i));return!1}if(r.test(n)){var o=n.split(r);for(var u=0,a=o.length;u<a;u++)e[t].apply(e,[o[u]].concat(i));return!1}return!0},s=function(e,t){var n,r=-1,i=e.length,s=t[0],o=t[1],u=t[2];switch(t.length){case 0:while(++r<i)(n=e[r]).callback.call(n.ctx);return;case 1:while(++r<i)(n=e[r]).callback.call(n.ctx,s);return;case 2:while(++r<i)(n=e[r]).callback.call(n.ctx,s,o);return;case 3:while(++r<i)(n=e[r]).callback.call(n.ctx,s,o,u);return;default:while(++r<i)(n=e[r]).callback.apply(n.ctx,t);return}},o={listenTo:"on",listenToOnce:"once"};return e.each(o,function(t,r){n[r]=function(n,r,i){var s=this._listeningTo||(this._listeningTo={}),o=n._listenId||(n._listenId=e.uniqueId("l"));return s[o]=n,!i&&typeof r=="object"&&(i=this),n[t](r,i,this),this}}),n});