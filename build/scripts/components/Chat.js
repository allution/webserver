define(["lib/react","lib/clib","stores/ChatStore","actions/ChatActions","game-logic/engine"],function(e,t,n,r,i){function u(){var e=n.getState();return e.engine=i,e}function a(e,t){var n=this,r="msg-chat-message";switch(e.type){case"say":e.role==="admin"&&(r+=" msg-admin-message");var i=n.state.engine.username;return i&&e.username!=i&&e.message.toLowerCase().indexOf(i.toLowerCase())!=-1&&(r+=" msg-highlight-message"),s.li({className:r,key:"msg"+t},s.a({href:"/user/"+e.username,target:"_blank"},e.username,":")," ",e.message);case"mute":return r="msg-mute-message",s.li({className:r,key:"msg"+t},s.a({href:"/user/"+e.moderator,target:"_blank"},"*** <"+e.moderator+">"),e.shadow?" shadow muted ":" muted ",s.a({href:"/user/"+e.username,target:"_blank"},"<"+e.username+">")," for "+e.timespec);case"error":case"info":return r="msg-info-message",s.li({className:r,key:"msg"+t},s.span(null," *** "+e.message));default:}}var s=e.DOM,o=120;return e.createClass({displayName:"Chat",getInitialState:function(){var e=u();return this.listLength=e.engine.chat.length,e},componentDidMount:function(){i.on({msg:this._onChange}),n.addChangeListener(this._onChange);var e=this.refs.messages.getDOMNode();e.scrollTop=e.scrollHeight},componentWillUnmount:function(){i.off({msg:this._onChange}),n.removeChangeListener(this._onChange);var e=this.refs.messages.getDOMNode().style.height;r.setHeight(e)},componentDidUpdate:function(e,t){if(t.engine.chat.length!=this.listLength){this.listLength=this.state.engine.chat.length;var n=this.refs.messages.getDOMNode(),r=n.scrollHeight-n.offsetHeight-n.scrollTop;r<o&&(n.scrollTop=n.scrollHeight)}},_onChange:function(){this.isMounted()&&this.setState(u())},_sendMessage:function(e){if(e.keyCode==13){var t=this.state.inputText;t.length>1&&t.length<500&&this._say(t)}},_say:function(e){r.say(e)},_updateInputText:function(e){r.updateInputText(e.target.value)},render:function(){var e=this,t=this.state.engine.chat.map(a,e),n;this.state.engine.username?n=s.input({className:"chat-input",onKeyDown:this._sendMessage,onChange:this._updateInputText,value:this.state.inputText,ref:"input",placeholder:"Type here..."}):n=s.input({className:"chat-input",ref:"input",placeholder:"Log in to chat...",disabled:!0});var r={height:this.state.height};return s.div({className:"messages-container"},s.ul({className:"messages",ref:"messages",style:r},t),n)}})});