define(["lib/react","lib/clib","lib/lodash","components/Countdown","components/BetButton","components/CashOutButton","actions/ControlsActions","stores/ControlsStore","stores/EngineVirtualStore"],function(e,t,n,r,i,s,o,u,a){function p(){return{betSize:u.getBetSize(),cashOut:u.getCashOut(),engine:a.getState()}}var f=e.createFactory(r),l=e.createFactory(i),c=e.createFactory(s),h=e.DOM;return e.createClass({displayName:"Controls",getInitialState:function(){return p()},componentDidMount:function(){u.addChangeListener(this._onChange),a.addChangeListener(this._onChange)},componentWillUnmount:function(){u.removeChangeListener(this._onChange),a.removeChangeListener(this._onChange)},_onChange:function(){this.isMounted()&&this.setState(p())},_placeBet:function(){var e=parseInt(this.state.betSize.replace(/k/g,"000"))*100;console.assert(n.isFinite(e));var t=parseFloat(this.state.cashOut);console.assert(n.isFinite(t)),t=Math.round(t*100),console.assert(n.isFinite(t)),o.placeBet(e,t)},_cancelBet:function(){o.cancelBet()},_cashOut:function(){o.cashOut()},_setBetSize:function(e){o.setBetSize(e)},_setAutoCashOut:function(e){o.setAutoCashOut(e)},_invalidBet:function(){var e=this;if(e.state.engine.balanceSatoshis<100)return"Not enough bits to play";var n=t.parseBet(e.state.betSize);if(n instanceof Error)return n.message;var r=t.parseAutoCash(e.state.cashOut);return r instanceof Error?r.message:e.state.engine.balanceSatoshis<n*100?"Not enough bits":null},_getStatusMessage:function(){var e=this.state.engine.currentPlay;if(this.state.engine.gameState==="STARTING")return f({engine:this.state.engine});if(this.state.engine.gameState==="IN_PROGRESS")return e&&e.bet&&!e.stopped_at?h.span(null,"Currently playing..."):e&&e.stopped_at?h.span(null,"Cashed Out @  ",h.b({className:"green"},e.stopped_at/100,"x")," / Won: ",h.b({className:"green"},t.formatSatoshis(e.bet*e.stopped_at/100))," ",t.grammarBits(e.bet*e.stopped_at/100)):h.span(null,"Game in progress..");if(this.state.engine.gameState==="ENDED"){var n;return e&&e.stopped_at?(e.bonus&&(n=h.span(null," (+",t.formatSatoshis(e.bonus)," ",t.grammarBits(e.bonus)," bonus)")),h.span(null,"Cashed Out @ ",h.b({className:"green"},e.stopped_at/100,"x")," / Won: ",h.b({className:"green"},t.formatSatoshis(e.bet*e.stopped_at/100))," ",t.grammarBits(e.bet*e.stopped_at/1e3),n)):e?(e.bonus&&(n=h.span(null," (+ ",t.formatSatoshis(e.bonus)," ",t.grammarBits(e.bonus)," bonus)")),h.span(null,"Game crashed @ ",h.b({className:"red"},this.state.engine.tableHistory[0].game_crash/100,"x")," / You lost ",h.b({className:"red"},e.bet/100)," ",t.grammarBits(e.bet),n)):h.span(null,"Game crashed @ ",h.b({className:"red"},this.state.engine.tableHistory[0].game_crash/100,"x"))}},_getControlInputs:function(){var e=this,t=h.div(null,h.span({className:"bet-span strong"},"Bet"),h.input({type:"text",name:"bet-size",value:e.state.betSize,onChange:function(t){e._setBetSize(t.target.value)}}),h.span({className:"sticky"},"Bits")),n=h.div(null,h.div({className:"auto-cash-out-span"},"Auto Cash Out @ "),h.input({min:1,step:.01,value:e.state.cashOut,type:"number",name:"cash-out",onChange:function(t){e._setAutoCashOut(t.target.value)}}),h.span({className:"sticky"},"x"));return h.div({className:"inputs-cont grid grid-pad"},h.div({className:"col-1-1"},t),h.div({className:"col-1-1"},n))},render:function(){var e=this,t=this.state.engine.currentPlay;if(!this.state.engine.username)return h.div({className:"login-container grid grid-pad"},h.div({className:"controls"},h.div({className:"login"},h.a({className:"big-button unselect",href:"/login"},"Login to play"),h.a({href:"/register",className:"register"},"or register "))));var n;this.state.engine.isBetting?n=!1:this.state.engine.gameState==="IN_PROGRESS"&&t&&t.bet&&!t.stopped_at?n=!1:n=!0;var r=n||this.state.engine.isBetting,i;r?i=l({engine:this.state.engine,invalidBet:this._invalidBet,placeBet:this._placeBet,cancelBet:this._cancelBet}):i=c({engine:this.state.engine,invalidBet:this._invalidBet,cashOut:this._cashOut});var s,o,u;return n?(s="col-1-2 mobile-col-1-1",u=h.div({className:"col-1-2 mobile-col-1-1"},this._getControlInputs())):(s="col-1-1 mobile-col-1-1",u=null),o=h.div({className:s},i),h.div(null,h.div({className:"controls-container"},h.h5({className:"information"},this._getStatusMessage()),h.div({className:"controls-grid grid grid-pad"},u,o)),h.div({className:"hash-cont"},h.span({className:"hash-text"},"Last Hash"),h.input({className:"hash-input",type:"text",value:this.state.engine.lastHash,readOnly:!0})))}})});